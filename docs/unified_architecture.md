# Architektura Zintegrowana: Bot + E-commerce + Admin Panel

## üéØ Cel
Stworzenie sp√≥jnego ekosystemu, gdzie wszystkie komponenty wsp√≥≈ÇdzielƒÖ dane i logikƒô biznesowƒÖ.

## üèóÔ∏è Architektura Mikrous≈Çugowa

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Load Balancer                           ‚îÇ
‚îÇ                         (Cloudflare)                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   E-commerce   ‚îÇ ‚îÇ Admin Panel  ‚îÇ ‚îÇ  Public API    ‚îÇ
‚îÇ   (Next.js)    ‚îÇ ‚îÇ   (React)    ‚îÇ ‚îÇ   (FastAPI)    ‚îÇ
‚îÇ shop.zagadka.pl‚îÇ ‚îÇadmin.zagadka ‚îÇ ‚îÇapi.zagadka.pl  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ   API Gateway   ‚îÇ
                  ‚îÇ   (Kong/Nginx)  ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                  ‚îÇ                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Auth Service   ‚îÇ ‚îÇPremium Service‚îÇ ‚îÇPayment Service ‚îÇ
‚îÇ  (FastAPI)     ‚îÇ ‚îÇ  (FastAPI)    ‚îÇ ‚îÇ   (FastAPI)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ                  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ  Message Queue  ‚îÇ
                  ‚îÇ  (RabbitMQ)     ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ  Discord Bot    ‚îÇ
                  ‚îÇ   (Python)      ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                  ‚îÇ                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL    ‚îÇ ‚îÇ    Redis      ‚îÇ ‚îÇ  File Storage  ‚îÇ
‚îÇ   (Primary)    ‚îÇ ‚îÇ   (Cache)     ‚îÇ ‚îÇ     (S3)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Komponenty Systemu

### 1. API Gateway
**Technologia**: Kong lub Nginx
**Funkcje**:
- Routing do odpowiednich serwis√≥w
- Rate limiting
- Authentication/Authorization
- Request/Response transformation
- Monitoring i analytics

### 2. Auth Service
**Odpowiedzialno≈õci**:
- Discord OAuth2
- JWT token management
- Session handling
- Permission management

**Endpoints**:
```
POST   /auth/discord/login
POST   /auth/discord/callback
POST   /auth/refresh
POST   /auth/logout
GET    /auth/me
```

### 3. Premium Service
**Odpowiedzialno≈õci**:
- ZarzƒÖdzanie subskrypcjami
- Weryfikacja uprawnie≈Ñ
- Statystyki premium

**Endpoints**:
```
GET    /premium/status/{discord_id}
POST   /premium/activate
PUT    /premium/upgrade
DELETE /premium/cancel
GET    /premium/statistics
```

### 4. Payment Service
**Odpowiedzialno≈õci**:
- Integracja ze Stripe
- Obs≈Çuga webhooks
- Generowanie faktur
- Historia transakcji

**Endpoints**:
```
POST   /payments/checkout
POST   /payments/stripe/webhook
GET    /payments/history/{discord_id}
GET    /payments/invoices/{payment_id}
POST   /payments/refund
```

### 5. Message Queue
**Technologia**: RabbitMQ lub Redis Pub/Sub
**Kolejki**:
```
premium.activated    ‚Üí Bot nadaje rolƒô
premium.expired      ‚Üí Bot odbiera rolƒô
premium.reminder     ‚Üí Bot wysy≈Ça DM
payment.completed    ‚Üí Email confirmation
payment.failed       ‚Üí Alert admins
```

## üì¶ Shared Libraries

### Python (dla Bot + Services)
```python
# zgdk-common/setup.py
setup(
    name='zgdk-common',
    packages=[
        'zgdk_common.models',      # SQLAlchemy models
        'zgdk_common.schemas',     # Pydantic schemas
        'zgdk_common.utils',       # Shared utilities
        'zgdk_common.events',      # Event definitions
        'zgdk_common.exceptions',  # Custom exceptions
    ]
)
```

### TypeScript (dla Frontend)
```typescript
// @zgdk/shared/package.json
{
  "name": "@zgdk/shared",
  "exports": {
    "./types": "./src/types/index.ts",
    "./api": "./src/api/client.ts",
    "./utils": "./src/utils/index.ts",
    "./constants": "./src/constants/index.ts"
  }
}
```

## üîÑ Workflows

### Zakup Premium przez Stronƒô
```mermaid
sequenceDiagram
    participant U as User
    participant W as Website
    participant AG as API Gateway
    participant AS as Auth Service
    participant PS as Payment Service
    participant MQ as Message Queue
    participant B as Bot
    participant D as Discord

    U->>W: Click "Buy Premium"
    W->>AG: GET /auth/discord/login
    AG->>AS: Initiate OAuth
    AS->>U: Redirect to Discord
    U->>D: Authorize
    D->>AS: Return code
    AS->>W: Return JWT token
    W->>AG: POST /payments/checkout
    AG->>PS: Create Stripe session
    PS->>U: Redirect to Stripe
    U->>PS: Complete payment
    PS->>AG: Webhook: payment.success
    AG->>PS: Verify & process
    PS->>MQ: Publish "premium.activated"
    MQ->>B: Consume event
    B->>D: Add premium role
    B->>MQ: Publish "role.added"
    PS->>U: Email confirmation
```

### Admin Dashboard - Monitoring
```mermaid
sequenceDiagram
    participant A as Admin
    participant D as Dashboard
    participant AG as API Gateway
    participant PS as Premium Service
    participant WS as WebSocket

    A->>D: Open dashboard
    D->>AG: GET /auth/me
    AG->>D: Admin verified
    D->>AG: GET /premium/statistics
    AG->>PS: Fetch stats
    PS->>D: Return data
    D->>WS: Subscribe to updates
    
    loop Real-time updates
        PS->>WS: New subscription
        WS->>D: Push update
        D->>A: Update UI
    end
```

## üîê Bezpiecze≈Ñstwo

### 1. API Security
- **JWT Tokens**: Short-lived (15min) z refresh tokens
- **API Keys**: Dla service-to-service communication
- **HMAC Signatures**: Dla webhooks (Stripe, Discord)
- **Rate Limiting**: Per IP i per user

### 2. Database Security
- **Encryption at rest**: Dla sensitive data
- **Row Level Security**: PostgreSQL RLS
- **Audit logs**: Wszystkie zmiany premium/payments
- **Backups**: Automated daily z retention 30 dni

### 3. Infrastructure Security
- **VPC**: Izolacja sieciowa
- **Secrets Management**: Vault lub AWS Secrets Manager
- **TLS everywhere**: Wewnƒôtrzna komunikacja te≈º encrypted
- **WAF**: Cloudflare lub AWS WAF

## üìä Monitoring i Observability

### 1. Metrics (Prometheus + Grafana)
```yaml
# Kluczowe metryki
- premium_subscriptions_active
- premium_subscriptions_new_daily
- payment_success_rate
- api_request_duration_seconds
- bot_command_execution_time
- database_connection_pool_usage
```

### 2. Logging (ELK Stack)
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "service": "payment-service",
  "level": "info",
  "correlation_id": "abc-123",
  "user_id": "123456789",
  "action": "premium.activated",
  "metadata": {
    "tier": "zG500",
    "duration_days": 30
  }
}
```

### 3. Tracing (Jaeger)
- Distributed tracing across services
- Bottleneck identification
- Error propagation tracking

## üöÄ Deployment

### Development
```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:15
  redis:
    image: redis:7
  rabbitmq:
    image: rabbitmq:3-management
  
  auth-service:
    build: ./services/auth
    env_file: .env.dev
  
  premium-service:
    build: ./services/premium
    env_file: .env.dev
  
  bot:
    build: ./bot
    env_file: .env.dev
```

### Production (Kubernetes)
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: premium-service
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
  template:
    spec:
      containers:
      - name: premium-service
        image: zgdk/premium-service:latest
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

## üìà Skalowanie

### Horizontal Scaling
- **Services**: Auto-scaling based on CPU/memory
- **Database**: Read replicas dla read-heavy operations
- **Cache**: Redis Cluster dla wysokiej dostƒôpno≈õci

### Vertical Scaling
- **Initial**: 2 vCPU, 4GB RAM per service
- **Growth**: Monitor i scale based on metrics
- **Database**: Start z db.t3.medium, scale w razie potrzeby

## üí∞ Koszty (Szacunkowe)

### PoczƒÖtkowe (100-1000 u≈ºytkownik√≥w)
- **Hosting**: ~$200/miesiƒÖc (Kubernetes cluster)
- **Database**: ~$50/miesiƒÖc (Managed PostgreSQL)
- **Stripe**: 2.9% + 1.20 PLN per transakcja
- **Cloudflare**: Free tier wystarczy

### Przy skali (10k+ u≈ºytkownik√≥w)
- **Hosting**: ~$1000/miesiƒÖc
- **Database**: ~$300/miesiƒÖc
- **CDN/DDoS**: ~$200/miesiƒÖc
- **Monitoring**: ~$100/miesiƒÖc

## üéØ Korzy≈õci Architektury

1. **Skalowalno≈õƒá**: Ka≈ºdy serwis niezale≈ºnie
2. **Maintainability**: Separation of concerns
3. **Reliability**: Failure isolation
4. **Flexibility**: ≈Åatwe dodawanie features
5. **Performance**: Optimized dla ka≈ºdego use case

## üîÑ Migration Path

### Faza 1: Monolith First (2-3 miesiƒÖce)
- Wszystko w jednym FastAPI app
- Fokus na business logic
- Quick time to market

### Faza 2: Extract Services (3-6 miesiƒôcy)
- Wydzielenie Auth Service
- Wydzielenie Payment Service
- API Gateway introduction

### Faza 3: Full Microservices (6+ miesiƒôcy)
- Kubernetes deployment
- Service mesh (Istio)
- Advanced monitoring

Ta architektura pozwala rozpoczƒÖƒá od prostego rozwiƒÖzania i ewoluowaƒá wraz z rosnƒÖcymi potrzebami.